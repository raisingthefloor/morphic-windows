# Common build steps used across different architectures
parameters:
  platform: ''  # x86, x64, or arm64
  runtimeIdentifier: ''  # win-x86, win-x64, or win-arm64
  defineConstants: ''  # Optional platform-specific constants

steps:
  - task: UseDotNet@2
    displayName: 'Use .NET Runtime 6.0.25 (install for AuzreSignTool 4.0.1)'
    inputs:
      packageType: runtime
      version: 6.0.25
      installationPath: $(Agent.ToolsDirectory)/dotnet

  - task: UseDotNet@2
    displayName: 'Use .NET SDK 8.0.408'
    inputs:
      packageType: sdk
      version: 8.0.408
      installationPath: $(Agent.ToolsDirectory)/dotnet

  - task: DotNetCoreCLI@2
    displayName: 'Install AzureSignTool 4.0.1'
    inputs:
      command: 'custom'
      custom: 'tool'
      arguments: 'install --global AzureSignTool --version 4.0.1'
  
  # Set a $(BUILD_TYPE) variable
  - bash: |
      BUILD_TYPE="Development"
      if [[ "${BRANCH}" == *"staging/"* ]]; then
        BUILD_TYPE="Staging"
      elif [[ "${BRANCH}" == *"release/"* ]]; then
        BUILD_TYPE="Production"
      fi
      echo "##vso[task.setvariable variable=BUILD_TYPE]${BUILD_TYPE}"
    env:
      BRANCH: $(Build.SourceBranch)
      BRANCH_NAME: $(Build.SourceBranchName)
          
  - task: Bash@3
    displayName: "write build info"
    env:
      BRANCH: $(Build.SourceBranch)
      BRANCH_NAME: $(Build.SourceBranchName)
      COMMIT: $(Build.SourceVersion)
      BUILD_NUM: $(Build.BuildNumber)
    inputs:
      targetType: 'filePath'
      filePath: set-build-info.sh

  - task: MSBuild@1
    displayName: "Build Morphic Client (${{ parameters.platform }})"
    env:
      VERSIONBUILDCOMPONENTS: '$(versionBuildComponents)'             
    inputs:       
      solution: '$(Build.SourcesDirectory)\Morphic.Client\Morphic.Client.csproj'
      platform: '${{ parameters.platform }}'
      configuration: '$(buildConfiguration)'
      msbuildArguments: '/t:restore,build /p:RuntimeIdentifier=${{ parameters.runtimeIdentifier }} /p:BuildType=$(BUILD_TYPE) ${{ parameters.defineConstants }}'

  - task: MSBuild@1
    displayName: "Publish Morphic Client (${{ parameters.platform }})"
    env:
      VERSIONBUILDCOMPONENTS: '$(versionBuildComponents)'             
    inputs:       
      solution: '$(Build.SourcesDirectory)\Morphic.Client\Morphic.Client.csproj'
      platform: '${{ parameters.platform }}'
      configuration: '$(buildConfiguration)'
      msbuildArguments: '/t:publish /p:RuntimeIdentifier=${{ parameters.runtimeIdentifier }} /p:BuildType=$(BUILD_TYPE) ${{ parameters.defineConstants }} /p:PublishDir=$(Build.ArtifactStagingDirectory)\publish\'

  - task: CmdLine@2
    displayName: 'sign morphic client exe (${{ parameters.platform }})'
    inputs:
      targetType: 'inline'
      script: >
        AzureSignTool sign
        -d Morphic
        -du "$(SigningURL)"
        -kvu "$(SigningVaultURL)"
        -kvi "$(SigningClientId)"
        -kvs "$(SigningClientSecret)"
        -kvt "$(AzureTenantId)"
        -kvc "$(SigningCertName)"
        -tr "$(TimestampUrl2)"
        -v
        $(Build.ArtifactStagingDirectory)\publish\Morphic.exe

  - task: VSBuild@1
    displayName: "restore installer dependencies"
    env:
      VERSIONBUILDCOMPONENTS: '$(versionBuildComponents)'
    inputs:
      solution: '$(Build.SourcesDirectory)\Morphic.Setup\Morphic.Setup.wixproj'
      configuration: '$(buildConfiguration)'
      msbuildArgs: '/t:restore'
  
  - task: VSBuild@1
    displayName: "restore installer dependencies (enterprise)"
    env:
      VERSIONBUILDCOMPONENTS: '$(versionBuildComponents)'
    inputs:
      solution: '$(Build.SourcesDirectory)\Morphic.Setup.Enterprise\Morphic.Setup.Enterprise.wixproj'
      configuration: '$(buildConfiguration)'
      msbuildArgs: '/t:restore'
          
  - task: VSBuild@1
    displayName: "build installer (${{ parameters.platform }})"
    env:
      VERSIONBUILDCOMPONENTS: '$(versionBuildComponents)'
    inputs:
      solution: '$(Build.SourcesDirectory)\Morphic.Setup\Morphic.Setup.wixproj'
      platform: '${{ parameters.platform }}'
      configuration: '$(buildConfiguration)'
      msbuildArgs: '/p:BuildType=$(BUILD_TYPE) /p:BuildProjectReferences=false /p:ClientOutputPath=$(Build.ArtifactStagingDirectory)\publish /p:HeatDirectoryPath=$(Build.ArtifactStagingDirectory)\publish'

  - task: CmdLine@2
    displayName: 'sign installer (${{ parameters.platform }})'
    inputs:
      targetType: 'inline'
      script: >
        AzureSignTool sign
        -d Morphic
        -du "$(SigningURL)"
        -kvu "$(SigningVaultURL)"
        -kvi "$(SigningClientId)"
        -kvt "$(AzureTenantId)"
        -kvs "$(SigningClientSecret)"
        -kvc "$(SigningCertName)"
        -tr "$(TimestampUrl2)"
        -v $(Build.ArtifactStagingDirectory)\${{ parameters.platform }}\$(buildConfiguration)\en-US\MorphicSetup.msi

  - publish: $(Build.ArtifactStagingDirectory)\${{ parameters.platform }}\$(buildConfiguration)\en-US\MorphicSetup.msi
    displayName: "Cache MSI for upload (${{ parameters.platform }})"
    artifact: msi-${{ parameters.platform }}

  - task: VSBuild@1
    displayName: "build installer (${{ parameters.platform }} enterprise)"
    env:
      VERSIONBUILDCOMPONENTS: '$(versionBuildComponents)'
    inputs:
      solution: '$(Build.SourcesDirectory)\Morphic.Setup.Enterprise\Morphic.Setup.Enterprise.wixproj'
      platform: '${{ parameters.platform }}'
      configuration: '$(buildConfiguration)'
      msbuildArgs: '/p:BuildType=$(BUILD_TYPE) /p:BuildProjectReferences=false /p:ClientOutputPath=$(Build.ArtifactStagingDirectory)\publish /p:HeatDirectoryPath=$(Build.ArtifactStagingDirectory)\publish'

  - task: CmdLine@2
    displayName: 'sign installer (${{ parameters.platform }} enterprise)'
    inputs:
      targetType: 'inline'
      script: >
        AzureSignTool sign
        -d Morphic
        -du "$(SigningURL)"
        -kvu "$(SigningVaultURL)"
        -kvi "$(SigningClientId)"
        -kvt "$(AzureTenantId)"
        -kvs "$(SigningClientSecret)"
        -kvc "$(SigningCertName)"
        -tr "$(TimestampUrl2)"
        -v $(Build.ArtifactStagingDirectory)\${{ parameters.platform }}\$(buildConfiguration)\en-US\MorphicEnterpriseSetup.msi

  - publish: $(Build.ArtifactStagingDirectory)\${{ parameters.platform }}\$(buildConfiguration)\en-US\MorphicEnterpriseSetup.msi
    displayName: "Cache MSI for upload (${{ parameters.platform }} enterprise)"
    artifact: msi-${{ parameters.platform }}-enterprise

  - publish: $(Build.ArtifactStagingDirectory)\publish\BuildVersion.txt
    displayName: "save build version numbers"
    artifact: build-version 